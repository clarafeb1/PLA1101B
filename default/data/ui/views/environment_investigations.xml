<form version="1.1">
  <label>conf24 Environment Investigations</label>
  <fieldset submitButton="false">
    <input type="text" token="host">
      <label>Host</label>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Hostwide Load Balancing</title>
      <chart>
        <search>
          <query>index=_introspection component=Hostwide host IN ($host$) earliest=-7d 
| `set_group`
| timechart span=1h p90(data.normalized_load_avg_1min) by group</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
      <html>
        If normally under 1, load is balanced well. If normally above 1, users might be having a bad time.
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Indexing Load</title>
      <input type="dropdown" token="idx_split_by">
        <label>Split By</label>
        <choice value="consolidated">Consolidated</choice>
        <choice value="processor">Processor</choice>
        <default>consolidated</default>
        <change>
          <condition value="consolidated">
            <set token="idx_split_by"></set>
          </condition>
          <condition>
            <set token="idx_split_by">by processor</set>
          </condition>
        </change>
      </input>
      <chart>
        <search>
          <query>index=_internal host IN ($host$) source=*metrics.log* group=pipeline  earliest=-7d| eval group = if(match(host, "^sh-"), "SH", "IDX") |search group="IDX"
| timechart span=1h per_second(cpu_seconds) as cpu_seconds $idx_split_by$</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
      <html>
        ADD NOTES HERE.
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Search Load on Indexers</title>
      <chart>
        <search>
          <query>index=_introspection host IN ($host$) component=Hostwide earliest=-7d 
| eval group = if(match(host, "^sh-"), "SH", "IDX") |search group="IDX"| eval CPU = 'data.cpu_count'*('data.cpu_system_pct'+'data.cpu_user_pct')/100
| stats avg(CPU) as CPU by _time host | timechart span=1h sum(CPU) as CPU</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
      <html>
        ADD NOTES HERE.
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Search Load</title>
      <input type="dropdown" token="sh_split_by">
        <label>Split By</label>
        <choice value="host">Host</choice>
        <choice value="app">App</choice>
        <choice value="user">User</choice>
        <choice value="provenance">Provenance</choice>
        <choice value="acceleration">Acceleration</choice>
        <default>provenance</default>
        <change>
          <condition value="host">
            <set token="sh_split_by">host</set>
          </condition>
          <condition value="app">
            <set token="sh_split_by">app</set>
          </condition>
          <condition value="user">
            <set token="sh_split_by">user</set>
          </condition>
          <condition value="provenance">
            <set token="sh_split_by">provenance</set>
          </condition>
        </change>
      </input>
      <table>
        <search>
          <query>index=_audit host IN ($host$) action=search info=completed earliest=-7d 
| `set_group`
| search group="SH" 
| eval acceleration = case(match(search_type, "_acceleration$"), savedsearch_name, provenance="summary_director", "summary_director", true(), "not an acceleration")
| stats sum(total_run_time) as seconds by $sh_split_by$ 
| sort - seconds|eventstats sum(seconds) as total_seconds|eval perc_load=round((seconds/total_seconds)*100,2)."%"|fields - total_seconds</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <html>
        ADD NOTES HERE.
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Large Lookups</title>
      <input type="text" token="mb_limit">
        <label>Lookup Size (MB)</label>
        <default>100</default>
      </input>
      <table>
        <search>
          <query>index=_audit path="*/lookups/*" TERM(size) TERM(lookups) (TERM(action=update) OR TERM(action=created) OR TERM(action=modified) OR TERM(action=add)) NOT TERM(action=search) host=$host$ | convert mktime(modtime) AS modtime timeformat="%a %b %d %H:%M:%S %Y" | stats latest(size) AS current_size by path host|rex field=path "apps\/(?&lt;app&gt;[^\/]+)\/lookups\/(?&lt;file&gt;.*)"|eval type="table"|eval current_size_mb=round(current_size/1024/1024,3)| search current_size_mb&gt;$mb_limit$
| append [| rest splunk_server=$host$ servicesNS/-/-/server/introspection/kvstore/collectionstats f=data 
    | mvexpand data
    | rex field=data "\{\"ns\"\:\"(?&lt;app&gt;\S*)\.(?&lt;file&gt;[^\"]+)\"\,\"size\"\:(?&lt;size&gt;\d+)"
    | eval path="app"."/".app."/".file
    | stats first(size) AS current_size by splunk_server app file path|rename splunk_server as host|eval type="kvstore"
    ```seaching for lookups with size```|eval current_size_mb=round(current_size/1024/1024,3)
    | search current_size_mb&gt;$mb_limit$]|fields - current_size|sort 0 - current_size_mb</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>
